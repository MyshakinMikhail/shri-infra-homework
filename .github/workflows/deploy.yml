name: Deploy to Production

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Release version (e.g. 12)"
                required: true

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            VERSION: ${{ github.event.inputs.version }}

        steps:
            - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SSH –∫–ª—é—á–∞
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.PROD_SERVER_IP }} <<EOF
                    docker login -u ${{ secrets.YCR_USERNAME }} -p ${{ secrets.YCR_PASSWORD }} cr.yandex
                    docker pull cr.yandex/${{ secrets.YCR_REGISTRY_ID }}/app:${VERSION}_latest
                    docker stop app || true
                    docker rm app || true
                    docker run -d -p 3000:3000 --name app cr.yandex/${{ secrets.YCR_REGISTRY_ID }}/app:${VERSION}_latest
                  EOF

            - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ Issue
              uses: peter-evans/create-or-update-comment@v4
              with:
                  issue-search: "Release v${{ env.VERSION }}"
                  comment-author: github-actions[bot]
                  body: |
                      üöÄ –†–µ–ª–∏–∑ **v${{ env.VERSION }}** –±—ã–ª —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–∞—á–∞–Ω –≤ –ø—Ä–æ–¥.

                      üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d')  
                      üë§ –ê–≤—Ç–æ—Ä: @${{ github.actor }}
