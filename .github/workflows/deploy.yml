name: Deploy to Production

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Release version (e.g. 12)"
                required: true

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            VERSION: ${{ github.event.inputs.version }}

        steps:
            - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SSH –∫–ª—é—á–∞
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.PROD_SERVER_IP }} <<EOF
                    docker login -u ${{ secrets.YCR_USERNAME }} -p ${{ secrets.YCR_PASSWORD }} cr.yandex
                    docker pull cr.yandex/${{ secrets.YCR_REGISTRY_ID }}/app:${VERSION}_latest
                    docker stop app || true
                    docker rm app || true
                    docker run -d -p 3000:3000 --name app cr.yandex/${{ secrets.YCR_REGISTRY_ID }}/app:${VERSION}_latest
                  EOF

            - name: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ issue –æ –≤—ã–∫–ª–∞–¥–∫–µ
              run: |
                  DATE=$(date '+%Y-%m-%d')
                  VERSION="v${{ env.VERSION }}"
                  AUTHOR="@${{ github.actor }}"
                  DOCKER_TAG="cr.yandex/${{ secrets.YCR_REGISTRY_ID }}/app:${VERSION}_latest"

                  {
                    echo "## üöÄ –ü—Ä–æ–¥ –≤—ã–∫–ª–∞–¥–∫–∞ —Ä–µ–ª–∏–∑–∞ ${VERSION}"
                    echo ""
                    echo "**üìÖ –î–∞—Ç–∞:** $DATE"
                    echo "**üë§ –ê–≤—Ç–æ—Ä:** $AUTHOR"
                    echo "**üê≥ Docker-–æ–±—Ä–∞–∑:** \`$DOCKER_TAG\`"
                  } > deploy.md

            - name: –°–æ–∑–¥–∞–Ω–∏–µ Issue –æ –≤—ã–∫–ª–∞–¥–∫–µ
              uses: peter-evans/create-issue-from-file@v4
              with:
                  title: "Deploy: Release v${{ env.VERSION }} –≤—ã–∫–∞—á–∞–Ω –≤ –ø—Ä–æ–¥"
                  content-filepath: ./deploy.md
